<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Feed</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/Babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clsx@2.0.0/dist/clsx.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.263.0/dist/umd/lucide-react.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Mock FirebaseContext for demonstration
    const FirebaseContext = React.createContext({
      images: [
        {
          id: "1",
          authId: "user1",
          displayName: "User One",
          image: { url: "https://via.placeholder.com/300", title: "Sample Image 1" },
          status: "public",
          photoUrl: "https://via.placeholder.com/30"
        },
        {
          id: "2",
          authId: "user2",
          displayName: "User Two",
          image: { url: "https://via.placeholder.com/300", title: "Sample Image 2" },
          status: "public",
          photoUrl: "https://via.placeholder.com/30"
        }
      ]
    });

    // Mock useProfileImage hook
    function useProfileImage(authId) {
      return "https://via.placeholder.com/30"; // Mock profile image URL
    }

    function ImageFeed() {
      const [showOption, setShowOption] = React.useState(null);
      const { images } = React.useContext(FirebaseContext);

      // Precompute profile images to avoid calling hook in loop
      const profileImages = React.useMemo(() => {
        const imagesMap = {};
        images.forEach(file => {
          imagesMap[file.authId] = useProfileImage(file.authId) || "../../assets/emptyProfileImg.svg";
        });
        return imagesMap;
      }, [images]);

      // Toggle options handler
      const toggleOptions = (id) => {
        setShowOption(showOption === id ? null : id);
      };

      // Download image with error handling
      const handleDownload = async (imageUrl, title) => {
        try {
          const response = await fetch(imageUrl);
          if (!response.ok) throw new Error("Image download failed");
          const blob = await response.blob();
          const downloadUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = downloadUrl;
          link.download = `${title}.jpg`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(downloadUrl);
        } catch (error) {
          console.error("Download failed:", error);
          alert("ইমেজ ডাউনলোড করতে সমস্যা হয়েছে।");
        }
      };

      return (
        <div className="columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-5 m-4">
          {images.map((file) => (
            <div
              key={file.id}
              className={clsx(
                "relative flex flex-col bg-gray-800/50 border border-gray-700 backdrop-blur-lg p-2 w-full items-center my-5 cursor-pointer rounded-lg overflow-hidden select-none",
                { hidden: file.status === "private" }
              )}
            >
              <div className="w-full h-full flex flex-col gap-2">
                <img
                  loading="lazy"
                  src={file.image.url}
                  alt={file.image.title}
                  className="w-full h-auto object-cover rounded-lg"
                />
                <div className="p-2 flex md:hidden items-center justify-between gap-2">
                  <div className="flex items-center gap-2">
                    <img
                      loading="lazy"
                      className="w-[30px] h-[30px] object-cover rounded-full"
                      src={profileImages[file.authId]}
                      alt="Profile"
                    />
                    <p className="text-[1rem] font-semibold text-white">{file.displayName}</p>
                  </div>
                  <div onClick={() => toggleOptions(file.id)}>
                    <Lucide.EllipsisVertical size={20} className="text-white" />
                  </div>
                </div>
              </div>

              <div className="optionBox bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-transparent via-transparent to-black absolute z-30 w-full h-full bottom-0 left-0 flex flex-col justify-between gap-1">
                <article className="flex justify-between items-center p-2">
                  <div className="flex items-center gap-1 bg-black/50 rounded-xl px-2 py-1">
                    <Lucide.Heart size={16} className="text-white" />
                    <h1 className="text-[15px] text-white">Like</h1>
                  </div>
                  <div onClick={() => toggleOptions(file.id)}>
                    <Lucide.EllipsisVertical size={20} className="text-white" />
                  </div>
                </article>

                <article className="p-2">
                  <div className="flex items-center gap-2">
                    <img
                      loading="lazy"
                      className="w-[30px] h-[30px] object-cover rounded-full"
                      src={profileImages[file.authId]}
                      alt="Profile"
                    />
                    <p className="text-[1rem] font-semibold text-white">{file.displayName}</p>
                  </div>
                </article>
              </div>

              <div
                className={clsx(
                  "bg-black/50 rounded-xl backdrop-blur-md px-2 py-2 absolute right-0 top-0 bottom-10 md:top-[25%] md:bottom-0 w-full h-[75%] z-40",
                  { block: showOption === file.id, hidden: showOption !== file.id }
                )}
              >
                <ul className="flex flex-col gap-2">
                  <li className="rounded-lg flex justify-start items-center cursor-pointer px-2 py-1 hover:bg-[#61DBFB] hover:text-black text-white">
                    Info
                  </li>
                  <li
                    onClick={() => handleDownload(file.image.url, file.image.title)}
                    className="rounded-lg flex justify-start items-center cursor-pointer px-2 py-1 hover:bg-[#61DBFB] hover:text-black text-white"
                  >
                    Download
                  </li>
                  <hr className="border-gray-600" />
                  <li className="rounded-lg flex justify-start items-center cursor-pointer px-2 py-1 hover:bg-red-500 hover:text-white text-red-500">
                    Delete
                  </li>
                </ul>
              </div>
            </div>
          ))}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(
      <FirebaseContext.Provider value={FirebaseContext._currentValue}>
        <ImageFeed />
      </FirebaseContext.Provider>
    );
  </script>
</body>
</html>